{% extends "base.html" %}
{% block title %}Pneumonia Detection{% endblock %}

{% block content %}
<div class="container py-5">
    <h2 class="text-center mb-4">Upload Chest X-ray Image</h2>

    <div class="row justify-content-center">
        <div class="col-md-6">
            <form method="POST" enctype="multipart/form-data">
                <div id="drop-area" class="mb-3">
                    <p id="drop-text">ðŸ“‚ Click or Drag & Drop X-ray Here</p>
                    <img id="preview" src="#" alt="Preview">
                </div>
                <input type="file" name="file" id="file-input" accept="image/*" style="display:none" onchange="previewImage(event)">
                <div class="text-center">
                    <button type="submit" class="btn btn-primary btn-lg">Predict</button>
                </div>
            </form>
        </div>
    </div>

    {% if prediction %}
    <div class="row justify-content-center mt-5">
        <div class="col-md-6">
            <div class="results-card text-center">
                <h3>Prediction Result:</h3>
                <h2 style="color: {% if prediction == 'PNEUMONIA' %}red{% else %}green{% endif %};">
                    {{ prediction }}
                </h2>
                <div class="mt-3">
                    <p><strong>Confidence:</strong></p>
                    <p>NORMAL: {{ prob.NORMAL * 100 }}%</p>
                    <p>PNEUMONIA: {{ prob.PNEUMONIA * 100 }}%</p>
                </div>
                {% if image_url %}
                <div class="mt-3">
                    <img src="{{ image_url }}" class="img-fluid rounded" style="max-height: 400px;">
                </div>
                {% endif %}
            </div>

            <div class="clinical-card mt-4">
                <h3>ðŸ“‹ Clinical Recommendations</h3>
                {% if prediction == 'NORMAL' %}
                <ul>
                    <li>âœ… Lungs appear clear and healthy.</li>
                    <li>Maintain a balanced diet and regular exercise.</li>
                    <li>Continue routine health check-ups.</li>
                    <li>Consult a doctor if any new respiratory symptoms appear.</li>
                </ul>
                {% else %}
                <ul>
                    <li>ðŸ©º Indicators suggest pneumonia â€” further clinical evaluation is advised.</li>
                    <li>Schedule a chest CT and complete blood test.</li>
                    <li>Follow your physicianâ€™s antibiotic regimen carefully.</li>
                    <li>Ensure rest, hydration, and regular temperature monitoring.</li>
                </ul>
                {% endif %}
            </div>
        </div>
    </div>
    {% endif %}

    {% if error %}
    <div class="row justify-content-center mt-3">
        <div class="col-md-6 text-center">
            <p class="text-danger">{{ error }}</p>
        </div>
    </div>
    {% endif %}
</div>

<script>
function previewImage(event) {
    var reader = new FileReader();
    reader.onload = function() {
        var output = document.getElementById('preview');
        output.src = reader.result;
        output.style.display = 'block';
        document.getElementById('drop-text').style.display = 'none';
    };
    reader.readAsDataURL(event.target.files[0]);
}

// Click drop area to open file selector
document.getElementById('drop-area').addEventListener('click', function() {
    document.getElementById('file-input').click();
});

// Drag & Drop
const dropArea = document.getElementById("drop-area");

dropArea.addEventListener("dragover", (e) => {
    e.preventDefault();
    dropArea.style.borderColor = "#115293";
});

dropArea.addEventListener("dragleave", (e) => {
    e.preventDefault();
    dropArea.style.borderColor = "#1976d2";
});

dropArea.addEventListener("drop", (e) => {
    e.preventDefault();
    const file = e.dataTransfer.files[0];
    if (file) {
        document.getElementById('file-input').files = e.dataTransfer.files;
        previewImage({ target: { files: [file] } });
    }
});
</script>
{% endblock %}
